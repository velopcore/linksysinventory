<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Linksys Inventory ‚Äî Full DB Mode</title>
<style>
  body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:12px; background:#f7f8fb; color:#111}
  .login-box,.app{max-width:1100px;margin:0 auto;background:#fff;border:1px solid #ddd;padding:12px;border-radius:8px}
  .container{display:flex;gap:12px}
  .left{flex:2;padding:10px} .right{flex:1;padding:10px}
  label{display:block;font-weight:600;margin-top:8px}
  input[type=text]{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc}
  button{padding:8px 12px;border-radius:6px;border:1px solid #aaa;background:#f6f6f6;cursor:pointer}
  button.primary{background:#0366d6;color:#fff;border-color:#0366d6}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid #e6e6e6;padding:6px;text-align:left}
  .msg{padding:8px;background:#eef7ee;border:1px solid #d5ecd6;border-radius:6px}
  .hidden{display:none}
</style>
</head>
<body>

<div class="login-box" id="loginBox">
  <h2>üîê Linksys Inventory ‚Äî Login</h2>
  <label>Username</label><input id="loginUser" />
  <label>Password</label><input id="loginPass" type="password" />
  <div style="margin-top:8px">
    <button id="btnLogin" class="primary">Login</button>
  </div>
  <div class="small" style="margin-top:8px">Users: admin / dennis / edmar / van / viewer</div>
  <div id="loginMsg" class="msg hidden"></div>
</div>

<div class="app hidden" id="app">
  <header style="display:flex;justify-content:space-between;align-items:center">
    <strong>Linksys Inventory System</strong>
    <div><span id="userInfo"></span> | <a href="#" id="btnLogout">Logout</a></div>
  </header>

  <div class="container" style="margin-top:10px">
    <div class="left">
      <h3>Item Details</h3>
      <label>Brand</label><input id="fBrand" class="upper">
      <label>Model Number</label><input id="fModel" class="upper">
      <label>Serial Number</label><input id="fSerial" class="upper">
      <label>Date Received</label><input id="fDate" placeholder="MM/DD/YYYY">
      <label>Location</label><input id="fLocation" class="upper">
      <label>Tracking Number</label><input id="fTracking" class="upper">
      <label>Remarks</label><input id="fRemarks" class="upper">
      <div style="margin-top:10px">
        <button id="btnClearForm">Clear Item Details</button>
      </div>
    </div>

    <div class="right">
      <h3>Actions</h3>
      <button id="btnAdd" class="primary">Add Item</button>
      <button id="btnSave">Save Changes</button>
      <button id="btnRemove">Remove Item</button>
      <hr>
      <label>Import CSV</label><input id="fileImport" type="file" accept=".csv">
      <div style="margin-top:8px">
        <button id="btnImport">Import</button>
        <button id="btnExport">Export</button>
      </div>
      <hr>
      <label>Search</label><input id="searchBox" placeholder="keyword...">
      <div style="margin-top:8px">
        <button id="btnSearch">Search</button>
        <button id="btnShowAll">Show All</button>
      </div>
      <div id="actionMsg" class="msg hidden" style="margin-top:10px"></div>
    </div>
  </div>

  <div style="margin-top:12px" class="bottom">
    <h3>Inventory Table</h3>
    <div style="overflow:auto">
      <table id="invTable"><thead><tr id="theadRow"></tr></thead><tbody id="tbodyRows"></tbody></table>
    </div>
    <div style="margin-top:6px">Last Action: <span id="lastAction">‚Äî</span></div>
  </div>

  <div id="activityLog" class="hidden" style="margin-top:12px">
    <h3>Activity Log</h3>
    <table id="activityTable"><thead><tr><th>User</th><th>Role</th><th>Action</th><th>Timestamp</th></tr></thead><tbody id="activityBody"></tbody></table>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const SHEET_URL = 'PASTE_YOUR_WEB_APP_EXEC_URL_HERE'; // <<--- set this to your Web App exec URL
const ADMIN_USERNAME = 'admin';
const FIELDS = ['Brand','Model Number','Serial Number','Date Received','Location','Tracking Number','Remarks'];
const USERS = {
  admin:{password:'admin123',role:'admin'},
  dennis:{password:'Th3password!',role:'admin'},
  edmar:{password:'Asdfg12345!',role:'staff'},
  van:{password:'P1nkR@nger!',role:'staff'},
  viewer:{password:'ViewOnly',role:'viewer'}
};

let inventory = []; // each item has RowIndex (0-based) plus fields
let activityLog = [];
let currentUser = null;
let selectedIndex = -1; // index into inventory array

function el(id){return document.getElementById(id);}
function show(elm){elm.classList.remove('hidden');}
function hide(elm){elm.classList.add('hidden');}
function now(){return new Date().toLocaleString();}

/* ---------- UI helpers ---------- */
function setActionMsg(t){ const d = el('actionMsg'); d.textContent = t; d.classList.remove('hidden'); setTimeout(()=>d.classList.add('hidden'),2000); }
function setLastAction(t){ el('lastAction').textContent = t; }

/* ---------- Build table ---------- */
function buildTable(){
  const thead = el('theadRow'); const tbody = el('tbodyRows');
  thead.innerHTML=''; tbody.innerHTML='';
  FIELDS.forEach(f=>{ const th=document.createElement('th'); th.textContent=f; thead.appendChild(th); });
  inventory.forEach((it, i)=>{
    const tr = document.createElement('tr'); tr.className='clickable';
    tr.onclick = ()=>{ loadToForm(i); };
    FIELDS.forEach(k=>{ const td=document.createElement('td'); td.textContent = it[k] || ''; tr.appendChild(td); });
    tbody.appendChild(tr);
  });
}

/* ---------- Load selected item into form ---------- */
function loadToForm(i){
  selectedIndex = i;
  const it = inventory[i] || {};
  el('fBrand').value = it['Brand'] || '';
  el('fModel').value = it['Model Number'] || '';
  el('fSerial').value = it['Serial Number'] || '';
  el('fDate').value = it['Date Received'] || '';
  el('fLocation').value = it['Location'] || '';
  el('fTracking').value = it['Tracking Number'] || '';
  el('fRemarks').value = it['Remarks'] || '';
}

/* ---------- Capture form ---------- */
function capture(){
  return {
    'Brand': (el('fBrand').value||'').toUpperCase(),
    'Model Number': (el('fModel').value||'').toUpperCase(),
    'Serial Number': (el('fSerial').value||'').toUpperCase(),
    'Date Received': (el('fDate').value||''),
    'Location': (el('fLocation').value||'').toUpperCase(),
    'Tracking Number': (el('fTracking').value||'').toUpperCase(),
    'Remarks': (el('fRemarks').value||'').toUpperCase()
  };
}

/* ---------- Google sync functions ---------- */
async function fetchInventoryFromSheet(){
  try {
    const res = await fetch(SHEET_URL + '?action=list', { method:'GET' });
    const rows = await res.json();
    // rows: array of { RowIndex:0, Brand:..., ... }
    inventory = rows.map(r => r);
    buildTable();
  } catch (err) {
    console.error('fetchInventoryFromSheet', err);
    // fallback: keep local inventory
  }
}

async function syncAdd(record){
  try {
    const body = { ...record, Type: 'add', _user: currentUser?.username, _role: currentUser?.role };
    const res = await fetch(SHEET_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    const j = await res.json();
    if (j.status === 'OK') {
      await fetchInventoryFromSheet(); // reload authoritative list
    } else {
      console.warn('Add returned', j);
    }
  } catch (err) { console.error('syncAdd', err); }
}

async function syncUpdate(record, rowIndex){
  try {
    const body = { ...record, Type: 'update', RowIndex: rowIndex, _user: currentUser?.username, _role: currentUser?.role };
    const res = await fetch(SHEET_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    const j = await res.json();
    if (j.status === 'OK') {
      await fetchInventoryFromSheet();
    } else {
      console.warn('Update returned', j);
    }
  } catch (err) { console.error('syncUpdate', err); }
}

async function syncDelete(rowIndex){
  try {
    const pw = prompt('Enter admin password to delete:');
    if (!pw) return false;
    const body = { Type:'delete', RowIndex: rowIndex, Password: pw, _user: currentUser?.username, _role: currentUser?.role };
    const res = await fetch(SHEET_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    const j = await res.json();
    if (j.status === 'OK') {
      await fetchInventoryFromSheet();
      return true;
    }
    if (j.status === 'DENIED') { alert('Incorrect password.'); return false; }
    alert('Delete failed'); return false;
  } catch (err) {
    console.error('syncDelete', err);
    alert('Delete failed (network).');
    return false;
  }
}

async function syncLog(entry){
  try {
    await fetch(SHEET_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({...entry, Type:'log'}) });
  } catch (err) { console.error('syncLog', err); }
}

/* ---------- Add / Save / Delete (use syncAdd/syncUpdate/syncDelete) ---------- */
async function addItem(){
  const it = capture();
  if (!it.Brand) return alert('Brand required');
  // call server
  await syncAdd(it);
  setActionMsg('Item Added');
  logAction('added item');
  // form cleared after reload
  clearForm();
}

async function saveItem(){
  if (selectedIndex < 0) return alert('Select row to save');
  const it = capture();
  const rowIndex = inventory[selectedIndex].RowIndex; // 0-based
  await syncUpdate(it, rowIndex);
  setActionMsg('Changes Saved');
  logAction('updated item');
  clearForm();
}

async function delItem(){
  if (selectedIndex < 0) return alert('Select row to delete');
  const rowIndex = inventory[selectedIndex].RowIndex;
  const ok = await syncDelete(rowIndex);
  if (!ok) return;
  setActionMsg('Item Removed');
  logAction('deleted item');
  clearForm();
}

/* ---------- Logging (local + remote) ---------- */
function logAction(action){
  if (!currentUser) return;
  const entry = { User: currentUser.username, Role: currentUser.role, Action: action };
  activityLog.push({ ...entry, time: now() });
  localStorage.setItem('linksys_activity_log', JSON.stringify(activityLog));
  syncLog(entry);
  setLastAction(`${currentUser.username} ${action} at ${now()}`);
  if (currentUser.role === 'admin') show(el('activityLog'));
}
function loadLocalLogs(){
  try { activityLog = JSON.parse(localStorage.getItem('linksys_activity_log')) || []; } catch(e) { activityLog = []; }
  // build activity table
  const body = el('activityBody'); if (!body) return;
  body.innerHTML = '';
  activityLog.forEach(l => {
    const tr = document.createElement('tr');
    ['user','role','action','time'].forEach(k => {
      const td = document.createElement('td'); td.textContent = l[k] || (k==='time' ? l.time : ''); tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}

/* ---------- Import / Export ---------- */
function downloadTemplate(){ const blob = new Blob([FIELDS.join(',') + '\n'], {type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='inventory_template.csv'; a.click(); URL.revokeObjectURL(a.href); setActionMsg('Template downloaded'); }
function exportInventoryCSV(){ const csv = FIELDS.join(',') + '\n' + inventory.map(r => FIELDS.map(f=>`"${(r[f]||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n'); const b = new Blob([csv], {type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `inventory_export_${(new Date()).toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(a.href); setActionMsg('Exported inventory'); }

/* ---------- Clear form ---------- */
function clearForm(){
  ['fBrand','fModel','fSerial','fDate','fLocation','fTracking','fRemarks'].forEach(id=>el(id).value='');
  selectedIndex = -1;
}

/* ---------- Login / Logout ---------- */
function login(){
  const u = el('loginUser').value.trim();
  const p = el('loginPass').value;
  const rec = USERS[u];
  if (!rec || rec.password !== p) { alert('Invalid'); return; }
  currentUser = { username: u, role: rec.role };
  localStorage.setItem('linksys_current_user', JSON.stringify(currentUser));
  hide(el('loginBox')); show(el('app')); el('userInfo').textContent = `${u} (${rec.role})`;
  if (rec.role === 'admin') show(el('activityLog'));
  // load authoritative list from sheet
  fetchInventoryFromSheet();
  loadLocalLogs();
  logAction('logged in');
}
function logout(){ logAction('logged out'); localStorage.removeItem('linksys_current_user'); location.reload(); }

/* ---------- Init ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  // uppercase inputs
  document.querySelectorAll('input.upper').forEach(i => i.addEventListener('input', ()=> i.value = i.value.toUpperCase()));
  // restore user if stored
  try {
    const u = JSON.parse(localStorage.getItem('linksys_current_user'));
    if (u) { currentUser = u; hide(el('loginBox')); show(el('app')); el('userInfo').textContent = `${u.username} (${u.role})`; if (u.role==='admin') show(el('activityLog')); fetchInventoryFromSheet(); loadLocalLogs(); }
  } catch(e){}
  // wire buttons
  el('btnLogin').onclick = login;
  el('btnLogout').onclick = e => { e.preventDefault(); logout(); };
  el('btnAdd').onclick = addItem;
  el('btnSave').onclick = saveItem;
  el('btnRemove').onclick = delItem;
  el('btnClearForm').onclick = clearForm;
  el('btnDownloadTemplate').onclick = downloadTemplate;
  el('btnExport').onclick = exportInventoryCSV;
  el('btnSearch').onclick = ()=>{
    const q = el('searchBox').value.toLowerCase();
    const filtered = inventory.filter(r => FIELDS.some(k => (r[k]||'').toString().toLowerCase().includes(q)));
    // render filtered
    const tbody = el('tbodyRows'); tbody.innerHTML = '';
    filtered.forEach(it=>{
      const tr = document.createElement('tr'); tr.onclick = ()=>{ const idx = inventory.findIndex(x=>x.RowIndex === it.RowIndex); loadToForm(idx); };
      FIELDS.forEach(f=>{const td=document.createElement('td'); td.textContent = it[f]||''; tr.appendChild(td);});
      tbody.appendChild(tr);
    });
  };
  el('btnShowAll').onclick = buildTable;
});
</script>
</body>
</html>
