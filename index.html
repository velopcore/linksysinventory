<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Linksys Inventory System (Standalone)</title>
<style>
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:12px; color:#111; background:#f7f8fb; }
  header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  h1 { font-size:18px; margin:0; }
  .login-box, .app { border:1px solid #ddd; border-radius:8px; padding:12px; max-width:1100px; margin:0 auto; background:#fff; box-shadow:0 1px 6px rgba(0,0,0,0.04); }
  .container { display:flex; gap:12px; }
  .left { flex:2; padding:10px; border:1px solid #eee; border-radius:6px; background:#fff; }
  .right { flex:1; padding:10px; border:1px solid #eee; border-radius:6px; background:#fff; }
  .bottom, .activity { margin-top:12px; padding:8px; border:1px solid #eee; border-radius:6px; background:#fff; }
  label { display:block; font-weight:600; margin-top:8px; font-size:13px; }
  input[type="text"], input[type="password"], input[type="file"], select { width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; font-size:13px; }
  button { padding:8px 12px; margin-top:8px; border-radius:6px; border:1px solid #aaa; background:#f6f6f6; cursor:pointer; font-size:13px; }
  button.primary { background:#0366d6; color:#fff; border-color:#0366d6; }
  button.warn { background:#ffefef; color:#a10000; border-color:#f5c2c2; }
  .small { font-size:12px; color:#666; margin-top:6px; }
  table { width:100%; border-collapse:collapse; margin-top:8px; font-size:13px; background:#fff; }
  th, td { border:1px solid #e6e6e6; padding:6px; text-align:left; vertical-align:top; }
  th { background:#fafafa; font-weight:700; }
  tr.clickable:hover { background:#f5fbff; cursor:pointer; }
  .msg { padding:8px; border-radius:6px; background:#eef7ee; border:1px solid #d5ecd6; color:#1a5b2a; margin-top:8px; }
  .hidden { display:none; }
  footer { margin-top:14px; text-align:center; color:#666; font-size:13px; }
  .notice { padding:8px; border-radius:6px; background:#fff8e6; border:1px solid #f1e0b3; color:#7a5b00; margin-top:8px; }
</style>
</head>
<body>

<div class="login-box" id="loginBox">
  <h1>üîê Linksys Inventory ‚Äî Login</h1>
  <div style="max-width:480px;margin-top:12px;">
    <label>Username</label>
    <input type="text" id="loginUser" autocomplete="username">
    <label>Password</label>
    <input type="password" id="loginPass" autocomplete="current-password">
    <div style="margin-top:10px;">
      <button id="btnLogin" class="primary">Login</button>
      <button id="btnQuit">Quit</button>
    </div>
    <div class="small" style="margin-top:8px;">Users: admin / dennis / edmar / van / viewer</div>
    <div id="loginMsg" class="msg hidden" style="margin-top:10px;"></div>
  </div>
</div>

<div class="app hidden" id="app">
  <header>
    <div><strong>Linksys Inventory System</strong></div>
    <div>
      <span id="userInfo" class="small"></span> | <a href="#" id="btnLogout">Logout</a>
    </div>
  </header>

  <div class="container">
    <div class="left">
      <h3>üßæ Item Details</h3>
      <label>Brand</label><input type="text" id="fBrand" class="upper">
      <label>Model Number</label><input type="text" id="fModel" class="upper">
      <label>Serial Number</label><input type="text" id="fSerial" class="upper">
      <label>Date Received (MM/DD/YYYY)</label><input type="text" id="fDate" placeholder="MM/DD/YYYY">
      <label>Location</label><input type="text" id="fLocation" class="upper">
      <label>Tracking Number</label><input type="text" id="fTracking" class="upper">
      <label>Remarks</label><input type="text" id="fRemarks" class="upper">

      <div style="display:flex;gap:8px;margin-top:8px;">
        <button id="btnClearForm">Clear</button>
        <button id="btnAdd" class="primary">Add Item</button>
        <button id="btnSave">Save</button>
        <button id="btnRemove" class="warn">Remove</button>
      </div>
    </div>

    <div class="right">
      <h3>‚öôÔ∏è Actions</h3>

      <hr>
      <label>Import/Export</label>
      <input type="file" id="fileImport" accept=".csv">
      <div style="margin-top:6px;">
        <button id="btnImport">Import</button>
        <button id="btnExport">Export</button>
      </div>

      <hr>
      <label>Search</label>
      <input type="text" id="searchBox" placeholder="keyword...">
      <div style="margin-top:6px;display:flex;gap:8px;">
        <button id="btnSearch">Search</button>
        <button id="btnShowAll">Show All</button>
        <button id="btnClearSearch">Clear</button>
      </div>

      <div style="margin-top:10px;">
        <button id="btnDownloadTemplate">Download CSV Template</button>
      </div>

      <div class="small" style="margin-top:12px;">Auto-sync to Google Sheets is enabled.</div>
      <div id="actionMsg" class="msg hidden" style="margin-top:10px;"></div>
      <div class="notice">This system automatically syncs inventory and logs every change + every 60 seconds.</div>
    </div>
  </div>

  <div class="bottom">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>üìã Inventory Table</h3>
      <div class="small">Last Action: <span id="lastAction">‚Äî</span></div>
    </div>
    <table id="invTable">
      <thead><tr id="theadRow"></tr></thead>
      <tbody id="tbodyRows"></tbody>
    </table>
    <div class="small">Click a row to load it in the form.</div>
  </div>

  <div class="activity hidden" id="activityLogBox">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>üïì Activity Log</h3>
      <div>
        <button id="btnExportLogs">Export Logs</button>
        <button id="btnClearLogs" class="warn">Clear Logs</button>
      </div>
    </div>
    <table id="activityTable">
      <thead><tr><th>User</th><th>Role</th><th>Action</th><th>Timestamp</th></tr></thead>
      <tbody id="activityBody"></tbody>
    </table>
  </div>

  <footer>Local storage + Automatic Google Sheets Sync</footer>
</div>

<script>
/* CONFIG */
const FIELDS = ["Brand","Model Number","Serial Number","Date Received","Location","Tracking Number","Remarks"];
const STORAGE_KEY = "linksys_inventory_v1";
const USER_KEY = "linksys_current_user";
const LOG_KEY = "linksys_activity_log";

const GOOGLE_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwHoZFN9Dhkl0nlPQXW_bRdppdA38JPONoj9UC6Z_FyIuyBmxwD0tXju8o0z23B6oRn/exec";
const GOOGLE_SPREADSHEET_ID = "1YaKGmumw0BFrlYNoWJhawRCTZkrUSuqeCk0dJR4H5PM";

const USERS={
  admin:{password:'admin123',role:'admin'},
  dennis:{password:'Th3password!',role:'admin'},
  edmar:{password:'Asdfg12345!',role:'staff'},
  van:{password:'P1nkR@nger!',role:'staff'},
  viewer:{password:'ViewOnly',role:'viewer'}
};

let inventory=[], activityLog=[], currentUser=null, selectedIndex=-1;

/* HELPERS */
function el(id){return document.getElementById(id);}
function show(x){x.classList.remove("hidden");}
function hide(x){x.classList.add("hidden");}
function now(){return new Date().toLocaleString();}
function setActionMsg(m){const d=el("actionMsg");d.textContent=m;show(d);setTimeout(()=>hide(d),2500);}

/* STORAGE */
function saveInv(){localStorage.setItem(STORAGE_KEY,JSON.stringify(inventory));}
function loadInv(){try{inventory=JSON.parse(localStorage.getItem(STORAGE_KEY))||[]}catch{inventory=[];} buildTable();}
function saveLogs(){localStorage.setItem(LOG_KEY,JSON.stringify(activityLog));}
function loadLogs(){try{activityLog=JSON.parse(localStorage.getItem(LOG_KEY))||[]}catch{activityLog=[];}}

/* LOG ACTION */
function logAction(a){
  if(!currentUser)return;
  const e={user:currentUser.username,role:currentUser.role,action:a,time:now()};
  activityLog.push(e); saveLogs();
  el("lastAction").textContent=`${e.user} ${e.action} at ${e.time}`;
  if(currentUser.role==="admin")buildActivity();
}

/* TABLE BUILD */
function buildTable(){
  const h=el("theadRow"), b=el("tbodyRows");
  h.innerHTML=""; b.innerHTML="";
  FIELDS.forEach(f=>{const th=document.createElement("th"); th.textContent=f; h.appendChild(th);});
  if(!inventory.length){
    b.innerHTML=`<tr><td colspan="${FIELDS.length}">No items</td></tr>`;
    return;
  }
  inventory.forEach((it,i)=>{
    const tr=document.createElement("tr");
    tr.classList.add("clickable");
    tr.onclick=()=>loadToForm(i);
    FIELDS.forEach(f=>{
      const td=document.createElement("td");
      td.textContent=it[f]||"";
      tr.appendChild(td);
    });
    b.appendChild(tr);
  });
}

function buildActivity(){
  const body=el("activityBody"); body.innerHTML="";
  activityLog.forEach(r=>{
    const tr=document.createElement("tr");
    ["user","role","action","time"].forEach(k=>{
      const td=document.createElement("td");
      td.textContent=r[k]||"";
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}

function loadToForm(i){
  selectedIndex=i;
  const it=inventory[i];
  el("fBrand").value=it["Brand"];
  el("fModel").value=it["Model Number"];
  el("fSerial").value=it["Serial Number"];
  el("fDate").value=it["Date Received"];
  el("fLocation").value=it["Location"];
  el("fTracking").value=it["Tracking Number"];
  el("fRemarks").value=it["Remarks"];
}

function capture(){
  return{
    "Brand":el("fBrand").value.toUpperCase(),
    "Model Number":el("fModel").value.toUpperCase(),
    "Serial Number":el("fSerial").value.toUpperCase(),
    "Date Received":el("fDate").value,
    "Location":el("fLocation").value.toUpperCase(),
    "Tracking Number":el("fTracking").value.toUpperCase(),
    "Remarks":el("fRemarks").value.toUpperCase()
  };
}

/* AUTO SYNC WRAPPER */
async function autoSyncAll(){
  try{await syncInventoryToGoogle();}catch{}
  try{await syncActivityToGoogle();}catch{}
  console.log("Auto-sync:",now());
}

/* INVENTORY OPERATIONS */
async function addItem(){
  const it=capture();
  if(!it.Brand)return alert("Brand required");
  inventory.unshift(it);
  saveInv(); buildTable(); clearForm();
  logAction("added item");
  await autoSyncAll();
}

async function saveItem(){
  if(selectedIndex<0)return alert("Select a row first");
  inventory[selectedIndex]=capture();
  saveInv(); buildTable(); clearForm();
  logAction("saved item");
  await autoSyncAll();
}

async function delItem(){
  if(selectedIndex<0)return alert("Select a row first");
  if(!confirm("Remove selected item?"))return;
  inventory.splice(selectedIndex,1);
  saveInv(); buildTable(); clearForm();
  logAction("removed item");
  await autoSyncAll();
}

/* IMPORT/EXPORT */
function importFile(f){
  const r=new FileReader();
  r.onload=e=>{
    const lines=e.target.result.split(/\r?\n/).filter(Boolean);
    const rows=[];
    for(let i=1;i<lines.length;i++){
      const p=lines[i].split(",").map(x=>x.replace(/^"|"$/g,""));
      const o={}; FIELDS.forEach((f,j)=>o[f]=p[j]||"");
      rows.push(o);
    }
    inventory=rows; saveInv(); buildTable();
    logAction("imported inventory");
    autoSyncAll();
  };
  r.readAsText(f);
}

function exportInventoryCSV(){
  const csv=FIELDS.join(",")+"\n"+inventory.map(r=>FIELDS.map(f=>`"${(r[f]||"").replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="inventory.csv"; a.click(); URL.revokeObjectURL(a.href);
}

function exportLogs(){
  const csv="User,Role,Action,Timestamp\n"+activityLog.map(l=>`${l.user},${l.role},"${l.action}",${l.time}`).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="activity_log.csv"; a.click(); URL.revokeObjectURL(a.href);
}

/* GOOGLE SYNC FUNCTIONS */
async function syncInventoryToGoogle(){
  const payload={
    type:"inventory",
    sheetId:GOOGLE_SPREADSHEET_ID,
    rows:inventory
  };
  const res=await fetch(GOOGLE_WEBAPP_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });
  if(res.ok)console.log("Inventory synced");
}

async function syncActivityToGoogle(){
  const payload={
    type:"activity",
    sheetId:GOOGLE_SPREADSHEET_ID,
    rows:activityLog
  };
  const res=await fetch(GOOGLE_WEBAPP_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });
  if(res.ok)console.log("Activity synced");
}

/* CLEAR FORM */
function clearForm(){
  ["fBrand","fModel","fSerial","fDate","fLocation","fTracking","fRemarks"].forEach(id=>el(id).value="");
  selectedIndex=-1;
}

/* LOGIN */
async function login(){
  const u=el("loginUser").value.trim();
  const p=el("loginPass").value;
  const rec=USERS[u];
  if(!rec||rec.password!==p)return alert("Invalid");
  currentUser={username:u,role:rec.role};
  localStorage.setItem(USER_KEY,JSON.stringify(currentUser));
  hide(el("loginBox")); show(el("app"));
  el("userInfo").textContent=`${u} (${rec.role})`;
  loadInv(); loadLogs(); buildActivity();
  logAction("logged in");
  await autoSyncAll();
}

/* LOGOUT */
async function logout(e){
  if(e)e.preventDefault();
  await autoSyncAll();
  logAction("logged out");
  localStorage.removeItem(USER_KEY);
  setTimeout(()=>location.reload(),300);
}

/* PERMISSIONS */
function applyPerms(){
  const r=currentUser.role;
  el("btnAdd").disabled=!(r==="admin"||r==="staff");
  el("btnSave").disabled=!(r==="admin"||r==="staff");
  el("btnRemove").disabled=!(r==="admin");
  el("btnImport").disabled=!(r==="admin");
  el("btnExport").disabled=!(r==="admin");
  r==="admin" ? show(el("activityLogBox")) : hide(el("activityLogBox"));
}

/* INIT */
document.addEventListener("DOMContentLoaded",()=>{
  document.querySelectorAll("input.upper").forEach(i=>i.addEventListener("input",()=>i.value=i.value.toUpperCase()));

  try{
    const u=JSON.parse(localStorage.getItem(USER_KEY));
    if(u){
      currentUser=u;
      hide(el("loginBox")); show(el("app"));
      el("userInfo").textContent=`${u.username} (${u.role})`;
      applyPerms();
      loadInv(); loadLogs(); buildActivity();
    }
  }catch{}

  el("btnLogin").onclick=login;
  el("btnLogout").onclick=logout;

  ["loginUser","loginPass"].forEach(id=>{
    el(id).addEventListener("keydown",e=>{
      if(e.key==="Enter"){e.preventDefault();login();}
    });
  });

  el("btnAdd").onclick=addItem;
  el("btnSave").onclick=saveItem;
  el("btnRemove").onclick=delItem;

  el("btnExport").onclick=exportInventoryCSV;
  el("btnImport").onclick=()=>{const f=el("fileImport").files[0];if(f)importFile(f);};
  el("btnDownloadTemplate").onclick=()=> {
    const b=new Blob([FIELDS.join(",")+"\n"],{type:"text/csv"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(b); a.download="template.csv"; a.click();
  };

  el("btnSearch").onclick=()=>{
    const q=el("searchBox").value.toLowerCase();
    const b=el("tbodyRows");
    b.innerHTML="";
    inventory.forEach((it,i)=>{
      if(FIELDS.some(f=>(it[f]||"").toLowerCase().includes(q))){
        const tr=document.createElement("tr"); tr.classList.add("clickable");
        tr.onclick=()=>loadToForm(i);
        FIELDS.forEach(f=>{
          const td=document.createElement("td");
          td.textContent=it[f]||""; tr.appendChild(td);
        });
        b.appendChild(tr);
      }
    });
  };

  el("btnShowAll").onclick=buildTable;
  el("btnClearSearch").onclick=()=>{el("searchBox").value="";buildTable();};

  el("btnExportLogs").onclick=exportLogs;
  el("btnClearLogs").onclick=async()=>{
    if(confirm("Clear logs?")){
      activityLog=[]; saveLogs(); buildActivity();
      logAction("cleared logs");
      await autoSyncAll();
    }
  };

  // Background auto-sync every 60 seconds
  setInterval(autoSyncAll,60000);

  loadInv(); loadLogs(); buildActivity();
});
</script>
</body>
</html>
