<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Linksys Inventory System (Standalone + Google Sync)</title>
<style>
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:12px; color:#111; background:#f7f8fb; }
  header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  h1 { font-size:18px; margin:0; }
  .login-box, .app { border:1px solid #ddd; border-radius:8px; padding:12px; max-width:1100px; margin:0 auto; background:#fff; box-shadow:0 1px 6px rgba(0,0,0,0.04); }
  .container { display:flex; gap:12px; }
  .left { flex:2; padding:10px; border:1px solid #eee; border-radius:6px; background:#fff; }
  .right { flex:1; padding:10px; border:1px solid #eee; border-radius:6px; background:#fff; }
  .bottom, .activity { margin-top:12px; padding:8px; border:1px solid #eee; border-radius:6px; background:#fff; }
  label { display:block; font-weight:600; margin-top:8px; font-size:13px; }
  input[type="text"], input[type="password"], input[type="file"], select { width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; font-size:13px; }
  button { padding:8px 12px; margin-top:8px; border-radius:6px; border:1px solid #aaa; background:#f6f6f6; cursor:pointer; font-size:13px; }
  button.primary { background:#0366d6; color:#fff; border-color:#0366d6; }
  button.warn { background:#ffefef; color:#a10000; border-color:#f5c2c2; }
  .small { font-size:12px; color:#666; margin-top:6px; }
  table { width:100%; border-collapse:collapse; margin-top:8px; font-size:13px; background:#fff; }
  th, td { border:1px solid #e6e6e6; padding:6px; text-align:left; vertical-align:top; }
  th { background:#fafafa; font-weight:700; }
  tr.clickable:hover { background:#f5fbff; cursor:pointer; }
  .msg { padding:8px; border-radius:6px; background:#eef7ee; border:1px solid #d5ecd6; color:#1a5b2a; margin-top:8px; }
  .hidden { display:none; }
  footer { margin-top:14px; text-align:center; color:#666; font-size:13px; display:none; }
</style>
</head>
<body>

<div class="login-box" id="loginBox">
  <h1>üîê Linksys Inventory ‚Äî Login</h1>
  <div style="max-width:480px;margin-top:12px;">
    <label>Username</label>
    <input type="text" id="loginUser" autocomplete="username">
    <label>Password</label>
    <input type="password" id="loginPass" autocomplete="current-password">
    <div style="margin-top:10px;">
      <button id="btnLogin" class="primary">Login</button>
      <button id="btnQuit">Quit</button>
    </div>
    <div class="small" style="margin-top:8px;">Users: admin / edmar / van / viewer</div>
    <div id="loginMsg" class="msg hidden" style="margin-top:10px;"></div>
  </div>
</div>

<div class="app hidden" id="app">
  <header>
    <div><strong>Linksys Inventory System</strong></div>
    <div>
      <span id="userInfo" class="small"></span> | <a href="#" id="btnLogout">Logout</a>
    </div>
  </header>

  <div class="container">
    <div class="left">
      <h3>üßæ Item Details</h3>
      <label>Brand</label><input type="text" id="fBrand" class="upper">
      <label>Model Number</label><input type="text" id="fModel" class="upper">
      <label>Serial Number</label><input type="text" id="fSerial" class="upper">
      <label>Date Received (MM/DD/YYYY)</label><input type="text" id="fDate" placeholder="MM/DD/YYYY">
      <label>Location</label><input type="text" id="fLocation" class="upper">
      <label>Tracking Number</label><input type="text" id="fTracking" class="upper">
      <label>Remarks</label><input type="text" id="fRemarks" class="upper">
      <button id="btnClearForm">Clear Item Details</button>
    </div>

    <div class="right">
      <h3>‚öôÔ∏è Actions</h3>
      <button id="btnAdd" class="primary">Add Item</button>
      <button id="btnSave">Save Changes</button>
      <button id="btnRemove" class="warn">Remove Item</button>
      <hr>
      <label>Import/Export</label>
      <input type="file" id="fileImport" accept=".csv">
      <div style="margin-top:6px;">
        <button id="btnImport">Import</button>
        <button id="btnExport">Export</button>
      </div>
      <hr>
      <label>Search</label>
      <input type="text" id="searchBox" placeholder="keyword...">
      <div style="margin-top:6px;display:flex;gap:8px;">
        <button id="btnSearch">Search</button>
        <button id="btnShowAll">Show All</button>
        <button id="btnClearSearch">Clear Search</button>
      </div>
      <div style="margin-top:10px;">
        <button id="btnDownloadTemplate">Download CSV Template</button>
      </div>
      <div id="actionMsg" class="msg hidden" style="margin-top:10px;"></div>
    </div>
  </div>

  <div class="bottom">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>üìã Inventory Table</h3>
      <div class="small">Last Action: <span id="lastAction">‚Äî</span></div>
    </div>
    <div id="tableWrap" style="overflow:auto;">
      <table id="invTable" role="table">
        <thead><tr id="theadRow"></tr></thead>
        <tbody id="tbodyRows"></tbody>
      </table>
    </div>
    <div class="small">Click a row to load it into the form.</div>
  </div>

  <div class="activity hidden" id="activityLogBox">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>üïì Activity Log</h3>
      <div>
        <button id="btnExportLogs">Export Logs (CSV)</button>
        <button id="btnClearLogs" class="warn">Clear Logs</button>
      </div>
    </div>
    <table id="activityTable">
      <thead>
        <tr>
          <th>User</th>
          <th>Role</th>
          <th>Action</th>
          <th>Serial Number</th>
          <th>Brand</th>
          <th>Model Number</th>
          <th>Location</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody id="activityBody"></tbody>
    </table>
  </div>
</div>

<script>
const FIELDS = ['Brand','Model Number','Serial Number','Date Received','Location','Tracking Number','Remarks'];
const STORAGE_KEY='linksys_inventory_v1',USER_KEY='linksys_current_user',LOG_KEY='linksys_activity_log';

// --- Google Sync URL ---
const SHEET_URL = "YOUR DEPLOYED URL HERE"; /* replace */

// Utility helpers
function el(id){return document.getElementById(id);}
function show(e){e.classList.remove('hidden');}
function hide(e){e.classList.add('hidden');}
function now(){return new Date().toLocaleString();}
function dateStamp(){return new Date().toLocaleDateString('en-US').replace(/\//g,'-');}
function setActionMsg(txt){const d=el('actionMsg');d.textContent=txt;show(d);setTimeout(()=>hide(d),2000);}

// ---------------- SYNC FUNCTIONS ----------------
async function syncInventory(record){
  try{
    await fetch(SHEET_URL,{
      method:'POST',mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({...record,Type:'inventory'})
    });
  }catch(err){console.log(err);}
}

async function syncActivityLog(entry){
  try{
    await fetch(SHEET_URL,{
      method:'POST',mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({...entry,Type:'log'})
    });
  }catch(err){console.log(err);}
}

// ---------------- LOGGING ----------------
let activityLog=[];
function loadLogs(){
  try{
    const raw=localStorage.getItem(LOG_KEY);
    let arr=raw?JSON.parse(raw):[];
    if(!Array.isArray(arr))arr=[];

    // Auto-migrate legacy logs
    arr=arr.map(it=>({
      user:it.user||it.User||'',
      role:it.role||it.Role||'',
      action:it.action||it.Action||'',
      serial:it.serial||it.Serial||it['Serial Number']||'',
      brand:it.brand||it.Brand||'',
      model:it.model||it.Model||it['Model Number']||'',
      location:it.location||it.Location||'',
      time:it.time||it.Time||now()
    }));

    activityLog=arr;
    localStorage.setItem(LOG_KEY,JSON.stringify(arr));
  }catch{
    activityLog=[];
  }
}

function saveLogs(){localStorage.setItem(LOG_KEY,JSON.stringify(activityLog));}

function logAction(action){
  const e={
    user:currentUser.username,
    role:currentUser.role,
    action,
    serial:(el('fSerial').value||'').toUpperCase(),
    brand:(el('fBrand').value||'').toUpperCase(),
    model:(el('fModel').value||'').toUpperCase(),
    location:(el('fLocation').value||'').toUpperCase(),
    time:now()
  };

  activityLog.push(e);
  saveLogs();

  el('lastAction').textContent=`${e.user} ${action} (SN: ${e.serial}) at ${e.time}`;

  if(currentUser.role==='admin')buildActivity();

  syncActivityLog({
    User:e.user,Role:e.role,Action:e.action,
    Serial:e.serial,Brand:e.brand,
    "Model Number":e.model,
    Location:e.location
  });
}

function buildActivity(){
  const body=el('activityBody');
  body.innerHTML='';
  activityLog.forEach(r=>{
    const tr=document.createElement('tr');
    ['user','role','action','serial','brand','model','location','time'].forEach(k=>{
      const td=document.createElement('td');
      td.textContent=r[k]||'';
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}

// ---------------- INVENTORY ----------------
let inventory=[],currentUser=null,selectedIndex=-1;

function saveInv(){localStorage.setItem(STORAGE_KEY,JSON.stringify(inventory));}
function loadInv(){inventory=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');buildTable();}

function buildTable(){
  const head=el('theadRow'), body=el('tbodyRows');
  head.innerHTML='';body.innerHTML='';
  FIELDS.forEach(f=>{const th=document.createElement('th');th.textContent=f;head.appendChild(th);});
  inventory.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.classList.add('clickable');
    tr.onclick=()=>loadToForm(i);
    FIELDS.forEach(f=>{
      const td=document.createElement('td');
      td.textContent=r[f]||'';
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}

function loadToForm(i){
  selectedIndex=i;
  const r=inventory[i];
  el('fBrand').value=r['Brand'];
  el('fModel').value=r['Model Number'];
  el('fSerial').value=r['Serial Number'];
  el('fDate').value=r['Date Received'];
  el('fLocation').value=r['Location'];
  el('fTracking').value=r['Tracking Number'];
  el('fRemarks').value=r['Remarks'];
}

function capture(){return{
  'Brand':el('fBrand').value.toUpperCase(),
  'Model Number':el('fModel').value.toUpperCase(),
  'Serial Number':el('fSerial').value.toUpperCase(),
  'Date Received':el('fDate').value,
  'Location':el('fLocation').value.toUpperCase(),
  'Tracking Number':el('fTracking').value.toUpperCase(),
  'Remarks':el('fRemarks').value.toUpperCase()
};}

function clearForm(){
  el('fBrand').value='';
  el('fModel').value='';
  el('fSerial').value='';
  el('fDate').value='';
  el('fLocation').value='';
  el('fTracking').value='';
  el('fRemarks').value='';
  selectedIndex=-1;
}

// FIXED VERSIONS: **Log BEFORE clearForm()**
function addItem(){
  const item=capture();
  if(!item.Brand)return alert('Brand required');
  inventory.unshift(item);
  saveInv(); syncInventory(item); buildTable();
  logAction('added item');   // BEFORE clearing
  clearForm();
  setActionMsg('Item Added');
}

function saveItem(){
  if(selectedIndex<0)return alert('Select row');
  const item=capture();
  inventory[selectedIndex]=item;
  saveInv(); syncInventory(item); buildTable();
  logAction('saved item');   // BEFORE clearing
  clearForm();
  setActionMsg('Changes Saved');
}

function delItem(){
  if(selectedIndex<0)return alert('Select row');
  if(!confirm('Remove selected?'))return;
  const item=inventory[selectedIndex];
  inventory.splice(selectedIndex,1);
  saveInv(); syncInventory(item); buildTable();
  logAction('removed item'); // BEFORE clearing
  clearForm();
  setActionMsg('Item Removed');
}

// ---------------- IMPORT / EXPORT ----------------
function importFile(f){
  const reader=new FileReader();
  reader.onload=e=>{
    const lines=e.target.result.split(/\r?\n/).filter(Boolean);
    inventory=lines.slice(1).map(l=>{
      const p=l.split(',').map(v=>v.replace(/^"|"$/g,''));
      const r={}; FIELDS.forEach((f,i)=>r[f]=p[i]||'');
      return r;
    });
    saveInv(); buildTable(); setActionMsg('Imported Inventory'); logAction('imported inventory');
  };
  reader.readAsText(f);
}

function exportInventoryCSV(){
  const csv=FIELDS.join(',')+'\n'+inventory.map(r=>FIELDS.map(f=>`"${(r[f]||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`inventory_export_${dateStamp()}.csv`;a.click();
  setActionMsg('Exported Inventory');logAction('exported inventory');
}

function exportLogs(){
  const header='User,Role,Action,Serial Number,Brand,Model Number,Location,Timestamp\n';
  const esc=s=>`"${(s||'').toString().replace(/"/g,'""')}"`;
  const rows=activityLog.map(l=>[
    esc(l.user),esc(l.role),esc(l.action),
    esc(l.serial),esc(l.brand),
    esc(l.model),esc(l.location),
    esc(l.time)
  ].join(',')).join('\n');
  const blob=new Blob([header+rows],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`activity_log_${dateStamp()}.csv`;a.click();
}

// ---------------- LOGIN ----------------
let currentUser=null;

function login(){
  const u=el('loginUser').value.trim(), p=el('loginPass').value;
  const rec=USERS[u];
  if(!rec||rec.password!==p)return alert('Invalid');
  currentUser={username:u,role:rec.role};
  localStorage.setItem(USER_KEY,JSON.stringify(currentUser));
  hide(el('loginBox')); show(el('app'));
  el('userInfo').textContent=`${u} (${rec.role})`;
  applyPerms(); loadLogs(); loadInv(); buildActivity();
  logAction('logged in');
}

function logout(){
  logAction('logged out');
  localStorage.removeItem(USER_KEY);
  location.reload();
}

function applyPerms(){
  const r=currentUser.role;
  el('btnAdd').disabled=!(r==='admin'||r==='staff');
  el('btnSave').disabled=!(r==='admin'||r==='staff');
  el('btnRemove').disabled=!(r==='admin');
  el('btnImport').disabled=!(r==='admin');
  el('btnExport').disabled=!(r==='admin');
  r==='admin'?show(el('activityLogBox')):hide(el('activityLogBox'));
}

// ---------------- INIT ----------------
document.addEventListener('DOMContentLoaded',()=>{
  document.querySelectorAll('input.upper').forEach(i=>i.addEventListener('input',()=>i.value=i.value.toUpperCase()));

  const saved=localStorage.getItem(USER_KEY);
  if(saved){
    currentUser=JSON.parse(saved);
    hide(el('loginBox')); show(el('app'));
    el('userInfo').textContent=`${currentUser.username} (${currentUser.role})`;
    applyPerms(); loadLogs(); loadInv(); buildActivity();
  }

  el('btnLogin').onclick=login;
  el('btnLogout').onclick=e=>{e.preventDefault();logout();};
  ['loginUser','loginPass'].forEach(id=>el(id).addEventListener('keydown',e=>{if(e.key==='Enter')login();}));

  el('btnAdd').onclick=addItem;
  el('btnSave').onclick=saveItem;
  el('btnRemove').onclick=delItem;
  el('btnImport').onclick=()=>{const f=el('fileImport').files[0];if(!f)return alert('Select CSV');importFile(f);};
  el('btnExport').onclick=exportInventoryCSV;
  el('btnDownloadTemplate').onclick=()=>downloadTemplate();
  el('btnSearch').onclick=()=>{
    const q=el('searchBox').value.toLowerCase();
    const rows=inventory.filter(r=>FIELDS.some(f=>(r[f]||'').toLowerCase().includes(q)));
    const body=el('tbodyRows');body.innerHTML='';
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      FIELDS.forEach(f=>{
        const td=document.createElement('td');td.textContent=r[f]||'';tr.appendChild(td);
      });
      body.appendChild(tr);
    });
  };
  el('btnShowAll').onclick=buildTable;
  el('btnClearForm').onclick=clearForm;
  el('btnClearSearch').onclick=()=>{el('searchBox').value='';buildTable();};
  el('btnExportLogs').onclick=exportLogs;
  el('btnClearLogs').onclick=()=>{if(confirm('Clear logs?')){activityLog=[];saveLogs();buildActivity();setActionMsg('Logs Cleared');}};
});
</script>

</body>
</html>
