<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Linksys Inventory — AutoSync</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:14px;background:#f7f8fb;color:#111}
  .card{max-width:1100px;margin:0 auto;background:#fff;padding:12px;border-radius:8px;border:1px solid #e6e6e6}
  header{display:flex;justify-content:space-between;align-items:center}
  h1{font-size:18px;margin:0}
  .row{display:flex;gap:12px}
  .left{flex:2;padding:10px}
  .right{flex:1;padding:10px}
  label{display:block;font-weight:600;margin-top:8px}
  input[type=text]{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc}
  button{padding:8px 12px;border-radius:6px;border:1px solid #aaa;background:#f6f6f6;cursor:pointer}
  button.primary{background:#0366d6;color:#fff;border-color:#0366d6}
  button.warn{background:#ffefef;color:#a10000;border-color:#f5c2c2}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid #e6e6e6;padding:6px;text-align:left}
  tr.clickable:hover{background:#f5fbff;cursor:pointer}
  .msg{padding:8px;border-radius:6px;background:#eef7ee;border:1px solid #d5ecd6;color:#1a5b2a;margin-top:8px}
  .small{font-size:13px;color:#666}
  .hidden{display:none}
  footer{margin-top:14px;text-align:center;color:#666}
</style>
</head>
<body>
  <div class="card" id="appCard">
    <header><h1>Linksys Inventory — AutoSync</h1>
      <div><span id="userInfo" class="small"></span> | <a href="#" id="btnLogout">Logout</a></div>
    </header>

    <div class="row" style="margin-top:12px">
      <div class="left">
        <label>Brand</label><input id="fBrand" type="text" class="upper">
        <label>Model Number</label><input id="fModel" type="text" class="upper">
        <label>Serial Number</label><input id="fSerial" type="text" class="upper">
        <label>Date Received</label><input id="fDate" type="text" placeholder="MM/DD/YYYY">
        <label>Location</label><input id="fLocation" type="text" class="upper">
        <label>Tracking Number</label><input id="fTracking" type="text" class="upper">
        <label>Remarks</label><input id="fRemarks" type="text" class="upper">
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="btnClear">Clear</button>
          <button id="btnAdd" class="primary">Add</button>
          <button id="btnSave">Save</button>
          <button id="btnRemove" class="warn">Remove</button>
        </div>
      </div>

      <div class="right">
        <div class="small">Auto-sync is ON (Inventory + ActivityLog)</div>
        <div id="syncStatus" class="msg hidden" style="margin-top:8px"></div>
        <div style="margin-top:12px" id="lastSynced">Last sync: —</div>
      </div>
    </div>

    <hr>
    <h3>Inventory</h3>
    <div style="overflow:auto">
      <table id="invTable"><thead><tr id="theadRow"></tr></thead><tbody id="tbodyRows"></tbody></table>
    </div>
    <div class="small" style="margin-top:8px">Click a row to load into form.</div>

    <hr>
    <h3>Activity Log</h3>
    <table id="activityTable"><thead><tr><th>User</th><th>Role</th><th>Action</th><th>Timestamp</th></tr></thead><tbody id="activityBody"></tbody></table>

    <footer>Local storage + Auto Google Sheets Sync</footer>
  </div>

<script>
/* ******* CONFIG ******* */
const GOOGLE_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwHoZFN9Dhkl0nlPQXW_bRdppdA38JPONoj9UC6Z_FyIuyBmxwD0tXju8o0z23B6oRn/exec"; // replace with your Web App URL (from Apps Script Deploy)
const GOOGLE_SPREADSHEET_ID = "1YaKGmumw0BFrlYNoWJhawRCTZkrUSuqeCk0dJR4H5PM"; // replace with your spreadsheet id
const FIELDS = ["Brand","Model Number","Serial Number","Date Received","Location","Tracking Number","Remarks"];
const USERS = { admin:{password:"admin123",role:"admin"}, dennis:{password:"Th3password!",role:"admin"}, edmar:{password:"Asdfg12345!",role:"staff"}, van:{password:"P1nkR@nger!",role:"staff"}, viewer:{password:"ViewOnly",role:"viewer"} };

/* ******* STATE ******* */
let inventory = [], activityLog = [], currentUser = {username:"admin",role:"admin"}, selectedIndex = -1;

/* ******* HELPERS ******* */
function el(id){return document.getElementById(id);}
function showMsg(text,timeout=2500){const s=el("syncStatus");s.textContent=text; s.classList.remove("hidden"); clearTimeout(s._t); s._t=setTimeout(()=>s.classList.add("hidden"),timeout);}
function setLastSynced(t){el("lastSynced").textContent = "Last sync: " + t;}

/* ******* TABLES & FORM ******* */
function buildTable(){
  el("theadRow").innerHTML=""; el("tbodyRows").innerHTML="";
  FIELDS.forEach(f=>{const th=document.createElement("th"); th.textContent=f; el("theadRow").appendChild(th);});
  if(!inventory.length){el("tbodyRows").innerHTML=`<tr><td colspan="${FIELDS.length}">No items</td></tr>`; return;}
  inventory.forEach((it,i)=>{
    const tr=document.createElement("tr"); tr.className="clickable";
    tr.onclick=()=>loadToForm(i);
    FIELDS.forEach(f=>{const td=document.createElement("td"); td.textContent = it[f] || ""; tr.appendChild(td);});
    el("tbodyRows").appendChild(tr);
  });
}
function buildActivity(){el("activityBody").innerHTML=""; activityLog.forEach(a=>{const tr=document.createElement("tr"); ["user","role","action","time"].forEach(k=>{const td=document.createElement("td"); td.textContent=a[k]||""; tr.appendChild(td);}); el("activityBody").appendChild(tr);});}
function capture(){return FIELDS.reduce((acc,f)=>{const id = "f"+f.replace(/\s+/g,""); acc[f] = (el(id) ? el(id).value : el("f"+f).value) || ""; return acc;}, {});}
function loadToForm(i){ selectedIndex=i; const it=inventory[i]; FIELDS.forEach(f=>{ const id="f"+f.replace(/\s+/g,""); if(el(id)) el(id).value = it[f]||""; });}
function clearForm(){FIELDS.forEach(f=>{const id="f"+f.replace(/\s+/g,""); if(el(id)) el(id).value="";}); selectedIndex=-1;}

/* Create form field ids on top-level for capture compatibility */
(function wireFormIds(){FIELDS.forEach(f=>{const id="f"+f.replace(/\s+/g,""); const elIn = document.getElementById(id); /* already exists in this markup */ });})();

/* ******* Storage ******* */
function saveLocal(){localStorage.setItem("inv_x", JSON.stringify(inventory)); localStorage.setItem("log_x", JSON.stringify(activityLog));}
function loadLocal(){try{inventory=JSON.parse(localStorage.getItem("inv_x"))||[]}catch{inventory=[]} try{activityLog=JSON.parse(localStorage.getItem("log_x"))||[]}catch{activityLog=[]}}

/* ******* Activity logging ******* */
function logAction(action){ const e = {user: currentUser.username, role: currentUser.role, action, time: new Date().toLocaleString()}; activityLog.push(e); saveLocal(); buildActivity(); }

/* ******* SYNC (client -> Apps Script) ******* */
async function syncInventory(){
  const payload = { type: "inventory", sheetId: GOOGLE_SPREADSHEET_ID, rows: inventory };
  const res = await fetch(GOOGLE_WEBAPP_URL, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)});
  const text = await res.text().catch(()=>"");
  if(res.ok){ setLastSynced(new Date().toLocaleString()); showMsg("Inventory synced"); logAction("synced inventory"); return true; }
  else { showMsg("Inventory sync failed: " + (text||res.status)); console.error("syncInventory", res.status, text); return false; }
}
async function syncActivity(){
  const payload = { type: "activity", sheetId: GOOGLE_SPREADSHEET_ID, rows: activityLog };
  const res = await fetch(GOOGLE_WEBAPP_URL, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)});
  const text = await res.text().catch(()=>"");
  if(res.ok){ setLastSynced(new Date().toLocaleString()); showMsg("Activity synced"); logAction("synced activity"); return true; }
  else { showMsg("Activity sync failed: " + (text||res.status)); console.error("syncActivity", res.status, text); return false; }
}
async function autoSyncAll(){
  try{ await syncInventory(); }catch(e){ console.warn("inventory sync err",e); }
  try{ await syncActivity(); }catch(e){ console.warn("activity sync err",e); }
}

/* ******* INVENTORY operations ******* */
async function addItem(){ const it = {}; FIELDS.forEach(f=>{const id="f"+f.replace(/\s+/g,""); it[f]=(el(id).value||"").toUpperCase()}); if(!it["Brand"]){alert("Brand required");return;} inventory.unshift(it); saveLocal(); buildTable(); clearForm(); logAction("added item"); await autoSyncAll(); }
async function saveItem(){ if(selectedIndex<0){ alert("Select a row"); return; } FIELDS.forEach(f=>{const id="f"+f.replace(/\s+/g,""); inventory[selectedIndex][f]=(el(id).value||"").toUpperCase()}); saveLocal(); buildTable(); clearForm(); logAction("saved item"); await autoSyncAll(); }
async function removeItem(){ if(selectedIndex<0){ alert("Select a row"); return; } if(!confirm("Remove selected?")) return; inventory.splice(selectedIndex,1); saveLocal(); buildTable(); clearForm(); logAction("removed item"); await autoSyncAll(); }

/* ******* INIT wiring ******* */
document.addEventListener("DOMContentLoaded", ()=>{
  // wire form element IDs to match capture
  FIELDS.forEach(f=>{const n = "f"+f.replace(/\s+/g,""); // already present in markup as same ids
    // uppercase input enforcement
    const input = document.getElementById(n);
    if(input) input.addEventListener("input", ()=> input.value = input.value.toUpperCase());
  });

  // test user (you may implement login if you want)
  currentUser = { username: "admin", role: "admin" };
  el("userInfo").textContent = `${currentUser.username} (${currentUser.role})`;

  // button wiring
  el("btnAdd").onclick = addItem;
  el("btnSave").onclick = saveItem;
  el("btnRemove").onclick = removeItem;
  el("btnClear").onclick = clearForm;
  el("btnLogout").onclick = async (e)=>{ e.preventDefault(); await autoSyncAll(); logAction("logged out"); localStorage.removeItem("inv_x"); localStorage.removeItem("log_x"); location.reload(); };

  // load local then render and auto-sync
  loadLocal(); buildTable(); buildActivity();

  // run an initial auto-sync in background (non-blocking)
  autoSyncAll().catch(console.warn);

  // periodic backup every 60s
  setInterval(()=>autoSyncAll().catch(console.warn), 60000);
});
</script>
</body>
</html>
