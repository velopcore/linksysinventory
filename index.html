<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Linksys Inventory System (Standalone)</title>
<style>
Â  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:12px; color:#111; background:#f7f8fb; }
Â  header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
Â  h1 { font-size:18px; margin:0; }
Â  .login-box, .app { border:1px solid #ddd; border-radius:8px; padding:12px; max-width:1100px; margin:0 auto; background:#fff; box-shadow:0 1px 6px rgba(0,0,0,0.04); }
Â  .container { display:flex; gap:12px; }
Â  .left { flex:2; padding:10px; border:1px solid #eee; border-radius:6px; background:#fff; }
Â  .right { flex:1; padding:10px; border:1px solid #eee; border-radius:6px; background:#fff; }
Â  .bottom, .activity { margin-top:12px; padding:8px; border:1px solid #eee; border-radius:6px; background:#fff; }
Â  label { display:block; font-weight:600; margin-top:8px; font-size:13px; }
Â  input[type="text"], input[type="password"], input[type="file"], select { width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; font-size:13px; }
Â  button { padding:8px 12px; margin-top:8px; border-radius:6px; border:1px solid #aaa; background:#f6f6f6; cursor:pointer; font-size:13px; }
Â  button.primary { background:#0366d6; color:#fff; border-color:#0366d6; }
Â  button.warn { background:#ffefef; color:#a10000; border-color:#f5c2c2; }
Â  .small { font-size:12px; color:#666; margin-top:6px; }
Â  table { width:100%; border-collapse:collapse; margin-top:8px; font-size:13px; background:#fff; }
Â  th, td { border:1px solid #e6e6e6; padding:6px; text-align:left; vertical-align:top; }
Â  th { background:#fafafa; font-weight:700; }
Â  tr.clickable:hover { background:#f5fbff; cursor:pointer; }
Â  .msg { padding:8px; border-radius:6px; background:#eef7ee; border:1px solid #d5ecd6; color:#1a5b2a; margin-top:8px; }
Â  .hidden { display:none; }
Â  footer { margin-top:14px; text-align:center; color:#666; font-size:13px; }
Â  .notice { padding:8px; border-radius:6px; background:#fff8e6; border:1px solid #f1e0b3; color:#7a5b00; margin-top:8px; }
</style>
</head>
<body>

<div class="login-box" id="loginBox">
Â  <h1>ğŸ” Linksys Inventory â€” Login</h1>
Â  <div style="max-width:480px;margin-top:12px;">
Â  Â  <label>Username</label>
Â  Â  <input type="text" id="loginUser" autocomplete="username">
Â  Â  <label>Password</label>
Â  Â  <input type="password" id="loginPass" autocomplete="current-password">
Â  Â  <div style="margin-top:10px;">
Â  Â  Â  <button id="btnLogin" class="primary">Login</button>
Â  Â  Â  <button id="btnQuit">Quit</button>
Â  Â  </div>
Â  Â  <div class="small" style="margin-top:8px;">Users: admin / dennis / edmar / van / viewer</div>
Â  Â  <div id="loginMsg" class="msg hidden" style="margin-top:10px;"></div>
Â  </div>
</div>

<div class="app hidden" id="app">
Â  <header>
Â  Â  <div><strong>Linksys Inventory System</strong></div>
Â  Â  <div>
Â  Â  Â  <span id="userInfo" class="small"></span> | <a href="#" id="btnLogout">Logout</a>
Â  Â  </div>
Â  </header>

Â  <div class="container">
Â  Â  <div class="left">
Â  Â  Â  <h3>ğŸ§¾ Item Details</h3>
Â  Â  Â  <label>Brand</label><input type="text" id="fBrand" class="upper">
Â  Â  Â  <label>Model Number</label><input type="text" id="fModel" class="upper">
Â  Â  Â  <label>Serial Number</label><input type="text" id="fSerial" class="upper">
Â  Â  Â  <label>Date Received (MM/DD/YYYY)</label><input type="text" id="fDate" placeholder="MM/DD/YYYY">
Â  Â  Â  <label>Location</label><input type="text" id="fLocation" class="upper">
Â  Â  Â  <label>Tracking Number</label><input type="text" id="fTracking" class="upper">
Â  Â  Â  <label>Remarks</label><input type="text" id="fRemarks" class="upper">
Â  Â  Â  <div style="display:flex;gap:8px;margin-top:8px;">
Â  Â  Â  Â  <button id="btnClearForm">Clear Item Details</button>
Â  Â  Â  Â  <button id="btnAdd" class="primary">Add Item</button>
Â  Â  Â  Â  <button id="btnSave">Save Changes</button>
Â  Â  Â  Â  <button id="btnRemove" class="warn">Remove Item</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="right">
Â  Â  Â  <h3>âš™ï¸ Actions</h3>
Â  Â  Â  <hr>
Â  Â  Â  <label>Import/Export</label>
Â  Â  Â  <input type="file" id="fileImport" accept=".csv">
Â  Â  Â  <div style="margin-top:6px;">
Â  Â  Â  Â  <button id="btnImport">Import</button>
Â  Â  Â  Â  <button id="btnExport">Export</button>
Â  Â  Â  </div>
Â  Â  Â  <hr>
Â  Â  Â  <label>Search</label>
Â  Â  Â  <input type="text" id="searchBox" placeholder="keyword...">
Â  Â  Â  <div style="margin-top:6px;display:flex;gap:8px;">
Â  Â  Â  Â  <button id="btnSearch">Search</button>
Â  Â  Â  Â  <button id="btnShowAll">Show All</button>
Â  Â  Â  Â  <button id="btnClearSearch">Clear Search</button>
Â  Â  Â  </div>

Â  Â  Â  <div style="margin-top:10px;">
Â  Â  Â  Â  <button id="btnDownloadTemplate">Download CSV Template</button>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="margin-top:12px; display:flex; gap:8px; flex-direction:column;">
Â  Â  Â  Â  <button id="btnSyncInv" class="primary">Sync Inventory to Google</button>
Â  Â  Â  Â  <button id="btnSyncActivity">Sync Activity Log to Google</button>
Â  Â  Â  </div>

Â  Â  Â  <div class="small" style="margin-top:12px;"></div>
Â  Â  Â  <div class="small" style="margin-top:12px;">Auto-save: <strong id="autoSaveMethod">localStorage + Google Sync</strong></div>
Â  Â  Â  <div id="actionMsg" class="msg hidden" style="margin-top:10px;"></div>
Â  Â  Â  <div class="notice">Note: Google sync uses the Apps Script Web App you deployed. Make sure it is deployed with appropriate access.</div>
Â  Â  </div>
Â  </div>

Â  <div class="bottom">
Â  Â  <div style="display:flex;justify-content:space-between;align-items:center;">
Â  Â  Â  <h3>ğŸ“‹ Inventory Table</h3>
Â  Â  Â  <div class="small">Last Action: <span id="lastAction">â€”</span></div>
Â  Â  </div>
Â  Â  <div id="tableWrap" style="overflow:auto;">
Â  Â  Â  <table id="invTable" role="table">
Â  Â  Â  Â  <thead><tr id="theadRow"></tr></thead>
Â  Â  Â  Â  <tbody id="tbodyRows"></tbody>
Â  Â  Â  </table>
Â  Â  </div>
Â  Â  <div class="small">Click a row to load it into the form.</div>
Â  </div>

Â  <div class="activity hidden" id="activityLogBox">
Â  Â  <div style="display:flex;justify-content:space-between;align-items:center;">
Â  Â  Â  <h3>ğŸ•“ Activity Log</h3>
Â  Â  Â  <div>
Â  Â  Â  Â  <button id="btnExportLogs">Export Logs (CSV)</button>
Â  Â  Â  Â  <button id="btnClearLogs" class="warn">Clear Logs</button>
Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  <table id="activityTable"><thead><tr><th>User</th><th>Role</th><th>Action</th><th>Timestamp</th></tr></thead><tbody id="activityBody"></tbody></table>
Â  </div>

Â  <footer>Local-only app Â· Data saved to your selected storage Â· Google sync active</footer>
</div>

<script>
/* ---------------------------
Â  Â Configuration & constants
Â  Â --------------------------- */
const FIELDS = ['Brand','Model Number','Serial Number','Date Received','Location','Tracking Number','Remarks'];
const STORAGE_KEY = 'linksys_inventory_v1';
const USER_KEY = 'linksys_current_user';
const LOG_KEY = 'linksys_activity_log';

// Embedded values you confirmed earlier
const GOOGLE_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwHoZFN9Dhkl0nlPQXW_bRdppdA38JPONoj9UC6Z_FyIuyBmxwD0tXju8o0z23B6oRn/exec";
const GOOGLE_SPREADSHEET_ID = "1YaKGmumw0BFrlYNoWJhawRCTZkrUSuqeCk0dJR4H5PM";

/* Users */
const USERS = {
Â  admin: { password: 'admin123', role: 'admin' },
Â  dennis: { password: 'Th3password!', role: 'admin' },
Â  edmar: { password: 'Asdfg12345!', role: 'staff' },
Â  van: { password: 'P1nkR@nger!', role: 'staff' },
Â  viewer: { password: 'ViewOnly', role: 'viewer' }
};

let inventory = [], activityLog = [], currentUser = null, selectedIndex = -1;
let displayedInventory = []; // <-- NEW: Array holding the currently visible items (full list or search results)

/* ---------------------------
Â  Â Small helpers
Â  Â --------------------------- */
function el(id) { return document.getElementById(id); }
function show(node) { node && node.classList.remove('hidden'); }
function hide(node) { node && node.classList.add('hidden'); }
function now() { return new Date().toLocaleString(); }
function dateStamp() { return new Date().toLocaleDateString('en-US').replace(/\//g,'-'); }
function setActionMsg(msg, timeout = 2500) {
Â  const d = el('actionMsg');
Â  d.textContent = msg;
Â  show(d);
Â  setTimeout(() => hide(d), timeout);
}

/* ---------------------------
Â  Â Persistence: localStorage
Â  Â --------------------------- */
function saveLogs() { localStorage.setItem(LOG_KEY, JSON.stringify(activityLog)); }
function loadLogs() {
Â  try { activityLog = JSON.parse(localStorage.getItem(LOG_KEY)) || []; } catch { activityLog = []; }
}
function saveInv() { localStorage.setItem(STORAGE_KEY, JSON.stringify(inventory)); }
function loadInv() {
Â  try { inventory = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { inventory = []; }
Â  buildTable(); // Call the main table builder which defaults to showing all
}

/* ---------------------------
Â  Â Activity logging
Â  Â --------------------------- */
function logAction(action) {
Â  if (!currentUser) return;
Â  const entry = { user: currentUser.username, role: currentUser.role, action, time: now() };
Â  activityLog.push(entry);
Â  saveLogs();
Â  el('lastAction').textContent = `${entry.user} ${entry.action} at ${entry.time}`;
Â  if (currentUser.role === 'admin') buildActivity();
}
function buildActivity() {
Â  const body = el('activityBody');
Â  body.innerHTML = '';
Â  activityLog.forEach(l => {
Â  Â  const tr = document.createElement('tr');
Â  Â  ['user','role','action','time'].forEach(k => {
Â  Â  Â  const td = document.createElement('td');
Â  Â  Â  td.textContent = l[k] || '';
Â  Â  Â  tr.appendChild(td);
Â  Â  });
Â  Â  body.appendChild(tr);
Â  });
}

/* ---------------------------
Â  Â Table rendering & form
Â  Â --------------------------- */
// Builds the header and populates displayedInventory with the full list.
function buildTable() {
Â  // Default: show the full inventory
Â  displayedInventory = inventory; 
Â  
Â  const h = el('theadRow');
Â  h.innerHTML = ''; 
Â  FIELDS.forEach(f => { const th = document.createElement('th'); th.textContent = f; h.appendChild(th); });
Â  
Â  // Now build the body using the displayed array
Â  buildTableFromDisplayed(); 
}

// Helper to render the table body based on the current contents of displayedInventory
function buildTableFromDisplayed() {
Â  const b = el('tbodyRows');
Â  b.innerHTML = ''; 
Â  
Â  if (!displayedInventory.length) {
Â  Â  const tr = document.createElement('tr');
Â  Â  const td = document.createElement('td');
Â  Â  td.colSpan = FIELDS.length;
Â  Â  td.textContent = 'No items';
Â  Â  tr.appendChild(td);
Â  Â  b.appendChild(tr);
Â  Â  return;
Â  }
Â  
Â  displayedInventory.forEach((it, i) => {
Â  Â  const tr = document.createElement('tr');
Â  Â  tr.classList.add('clickable');
Â  Â  // FIX: loadToForm now uses the index 'i' in the displayedInventory array.
Â  Â  tr.onclick = () => loadToForm(i); 
Â  Â  FIELDS.forEach(f => {
Â  Â  Â  const td = document.createElement('td');
Â  Â  Â  td.textContent = it[f] || '';
Â  Â  Â  tr.appendChild(td);
Â  Â  });
Â  Â  b.appendChild(tr);
Â  });
}


// loads an item from the current displayed list (full list or search result)
function loadToForm(i) {
Â  selectedIndex = i;
Â  // FIX: Get the item from the currently displayed list
Â  const it = displayedInventory[i] || {}; 
Â  el('fBrand').value = it['Brand'] || '';
Â  el('fModel').value = it['Model Number'] || '';
Â  el('fSerial').value = it['Serial Number'] || '';
Â  el('fDate').value = it['Date Received'] || '';
Â  el('fLocation').value = it['Location'] || '';
Â  el('fTracking').value = it['Tracking Number'] || '';
Â  el('fRemarks').value = it['Remarks'] || '';
}

function capture() {
Â  return {
Â  Â  'Brand': (el('fBrand').value || '').toUpperCase(),
Â  Â  'Model Number': (el('fModel').value || '').toUpperCase(),
Â  Â  'Serial Number': (el('fSerial').value || '').toUpperCase(),
Â  Â  'Date Received': (el('fDate').value || ''),
Â  Â  'Location': (el('fLocation').value || '').toUpperCase(),
Â  Â  'Tracking Number': (el('fTracking').value || '').toUpperCase(),
Â  Â  'Remarks': (el('fRemarks').value || '').toUpperCase()
Â  };
}

function clearForm() {
Â  ['fBrand','fModel','fSerial','fDate','fLocation','fTracking','fRemarks'].forEach(id => el(id).value = '');
Â  selectedIndex = -1;
Â  setActionMsg('Item Details Cleared');
}

/* ---------------------------
Â  Â Inventory operations (with auto-sync hooks)
Â  Â --------------------------- */
async function addItem() {
Â  const it = capture();
Â  if (!it.Brand) return alert('Brand required');
Â  inventory.unshift(it);
Â  saveInv();
Â  buildTable(); // Rebuilds table (shows all)
Â  clearForm();
Â  setActionMsg('Item Added');
Â  logAction('added item');
Â  await autoSyncAll(); 
}

async function saveItem() {
Â  if (selectedIndex < 0) return alert('Select row');
Â  const it = capture();
Â  // NOTE: This uses the index in displayedInventory, which only works 
Â  // because we are *not* filtering when adding/saving/deleting. 
Â  // To make this robust, we need to find the item in the full 'inventory' array 
Â  // based on a unique ID (like Serial Number), but we'll stick to the index for simplicity.
Â  
Â  // Find the item's original index in the full inventory list by comparing serial numbers (or better yet, a hidden ID)
Â  const serialToFind = displayedInventory[selectedIndex]['Serial Number'];
Â  const originalIndex = inventory.findIndex(item => item['Serial Number'] === serialToFind);
Â  
Â  if (originalIndex > -1) {
Â  Â  inventory[originalIndex] = it;
Â  Â  saveInv();
Â  Â  buildTable();
Â  Â  clearForm();
Â  Â  setActionMsg('Changes Saved');
Â  Â  logAction('saved item');
Â  Â  await autoSyncAll(); 
Â  } else {
Â  Â  setActionMsg('Error: Item not found in main inventory.');
Â  }
}

async function delItem() {
Â  if (selectedIndex < 0) return alert('Select row');
Â  if (!confirm('Remove selected?')) return;
Â  
Â  // Find the item's original index in the full inventory list
Â  const serialToFind = displayedInventory[selectedIndex]['Serial Number'];
Â  const originalIndex = inventory.findIndex(item => item['Serial Number'] === serialToFind);
Â  
Â  if (originalIndex > -1) {
Â  Â  inventory.splice(originalIndex, 1);
Â  Â  saveInv();
Â  Â  buildTable();
Â  Â  clearForm();
Â  Â  setActionMsg('Item Removed');
Â  Â  logAction('removed item');
Â  Â  await autoSyncAll();
Â  } else {
Â  Â  setActionMsg('Error: Item not found in main inventory for removal.');
Â  }
}

/* ---------------------------
Â  Â CSV import/export (simple)
Â  Â --------------------------- */
function exportInventoryCSV() {
Â  const csv = FIELDS.join(',') + '\n' + inventory.map(r => FIELDS.map(f => `"${(r[f]||'').replace(/"/g,'""')}"`).join(',')).join('\n');
Â  const blob = new Blob([csv], { type: 'text/csv' });
Â  const a = document.createElement('a');
Â  a.href = URL.createObjectURL(blob);
Â  a.download = `inventory_export_${dateStamp()}.csv`;
Â  a.click();
Â  URL.revokeObjectURL(a.href);
Â  setActionMsg('Exported Inventory');
Â  logAction('exported inventory');
}

function exportLogs() {
Â  const csv = 'User,Role,Action,Timestamp\n' + activityLog.map(l => `${l.user},${l.role},"${l.action}",${l.time}`).join('\n');
Â  const blob = new Blob([csv], { type: 'text/csv' });
Â  const a = document.createElement('a');
Â  a.href = URL.createObjectURL(blob);
Â  a.download = `activity_log_${dateStamp()}.csv`;
Â  a.click();
Â  URL.revokeObjectURL(a.href);
Â  setActionMsg('Exported Logs');
Â  logAction('exported logs');
}

/* Simple CSV import (naive â€” does not fully support quoted CSV with embedded newlines) */
function importFile(f) {
Â  const r = new FileReader();
Â  r.onload = e => {
Â  Â  const lines = e.target.result.split(/\r?\n/).filter(Boolean);
Â  Â  const rows = [];
Â  Â  // Check for header row
Â  Â  const headers = lines.length > 0 ? lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, '')) : [];
Â  Â  
Â  Â  for (let i = 1; i < lines.length; i++) {
Â  Â  Â  // Naive split: assume fields do not contain commas
Â  Â  Â  const p = lines[i].split(',').map(x => x.trim().replace(/^"|"$/g, ''));
Â  Â  Â  const o = {};
Â  Â  Â  // Map CSV columns to expected FIELDS, using positional index
Â  Â  Â  FIELDS.forEach((f, j) => o[f] = p[j] || '');
Â  Â  Â  rows.push(o);
Â  Â  }
Â  Â  inventory = rows;
Â  Â  saveInv();
Â  Â  buildTable();
Â  Â  setActionMsg('Imported Inventory');
Â  Â  logAction('imported inventory');
Â  Â  // auto-sync after import
Â  Â  autoSyncAll();
Â  };
Â  r.readAsText(f);
}

function downloadTemplate() {
Â  const b = new Blob([FIELDS.join(',') + '\n'], { type: 'text/csv' });
Â  const a = document.createElement('a');
Â  a.href = URL.createObjectURL(b);
Â  a.download = 'inventory_template.csv';
Â  a.click();
Â  URL.revokeObjectURL(a.href);
Â  setActionMsg('Template Downloaded');
Â  logAction('downloaded template');
}

/* ---------------------------
Â  Â Auto-sync wrapper & schedule
Â  Â --------------------------- */
async function autoSyncAll() {
Â  // run inventory sync then activity sync, but don't throw on errors
Â  try {
Â  Â  await syncInventoryToGoogle();
Â  } catch (e) {
Â  Â  console.warn("Auto-sync inventory failed:", e);
Â  }
Â  try {
Â  Â  await syncActivityToGoogle();
Â  } catch (e) {
Â  Â  console.warn("Auto-sync activity failed:", e);
Â  }
Â  console.log("Auto-sync attempt:", new Date().toLocaleString());
}

/* ---------------------------
Â  Â Google Sheets sync functions
Â  Â --------------------------- */
async function syncInventoryToGoogle() {
Â  const payload = { type: 'inventory', sheetId: GOOGLE_SPREADSHEET_ID, rows: inventory };
Â  try {
Â  Â  const res = await fetch(GOOGLE_WEBAPP_URL, {
Â  Â  Â  method: 'POST',
Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  body: JSON.stringify(payload)
Â  Â  });
Â  Â  const text = await res.text();
Â  Â  if (res.ok) {
Â  Â  Â  setActionMsg('Inventory synced to Google Sheets');
Â  Â  Â  logAction('synced inventory to google');
Â  Â  } else {
Â  Â  Â  setActionMsg('Failed to sync inventory: ' + (text || res.status));
Â  Â  Â  console.error('Sync inventory failed', res.status, text);
Â  Â  }
Â  Â  return res;
Â  } catch (err) {
Â  Â  setActionMsg('Error syncing inventory (network)');
Â  Â  console.error('Network or fetch error (inventory):', err);
Â  Â  throw err;
Â  }
}

async function syncActivityToGoogle() {
Â  const payload = { type: 'activity', sheetId: GOOGLE_SPREADSHEET_ID, rows: activityLog };
Â  try {
Â  Â  const res = await fetch(GOOGLE_WEBAPP_URL, {
Â  Â  Â  method: 'POST',
Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  body: JSON.stringify(payload)
Â  Â  });
Â  Â  const text = await res.text();
Â  Â  if (res.ok) {
Â  Â  Â  setActionMsg('Activity log synced to Google Sheets');
Â  Â  Â  logAction('synced activity to google');
Â  Â  } else {
Â  Â  Â  setActionMsg('Failed to sync activity: ' + (text || res.status));
Â  Â  Â  console.error('Sync activity failed', res.status, text);
Â  Â  }
Â  Â  return res;
Â  } catch (err) {
Â  Â  setActionMsg('Error syncing activity (network)');
Â  Â  console.error('Network or fetch error (activity):', err);
Â  Â  throw err;
Â  }
}

/* ---------------------------
Â  Â Login & permissions
Â  Â --------------------------- */
async function login() {
Â  const u = el('loginUser').value.trim();
Â  const p = el('loginPass').value;
Â  const rec = USERS[u];
Â  if (!rec || rec.password !== p) {
Â  Â  el('loginMsg').textContent = 'Invalid username or password';
Â  Â  show(el('loginMsg'));
Â  Â  return;
Â  }
Â  hide(el('loginMsg'));

Â  currentUser = { username: u, role: rec.role };
Â  localStorage.setItem(USER_KEY, JSON.stringify(currentUser));
Â  hide(el('loginBox'));
Â  show(el('app'));
Â  el('userInfo').textContent = `${u} (${rec.role})`;
Â  applyPerms();
Â  loadLogs();
Â  loadInv();
Â  buildActivity();
Â  logAction('logged in');
Â  try {
Â  Â  // Immediately sync logs/inventory after login (optional)
Â  Â  await autoSyncAll();
Â  } catch (e) {
Â  Â  console.warn('Initial sync after login failed:', e);
Â  }
}

async function logout(e) {
Â  if (e && e.preventDefault) e.preventDefault();
Â  try {
Â  Â  await autoSyncAll(); // sync before logging out
Â  } catch (err) {
Â  Â  console.warn('Auto-sync before logout failed:', err);
Â  }
Â  logAction('logged out');
Â  localStorage.removeItem(USER_KEY);
Â  // slight delay so last log action can be saved (and synced)
Â  setTimeout(() => location.reload(), 200);
}

function applyPerms() {
Â  const r = currentUser.role;
Â  el('btnAdd').disabled = !(r === 'admin' || r === 'staff');
Â  el('btnSave').disabled = !(r === 'admin' || r === 'staff');
Â  el('btnRemove').disabled = !(r === 'admin');
Â  el('btnImport').disabled = !(r === 'admin');
Â  el('btnExport').disabled = !(r === 'admin');
Â  (r === 'admin') ? show(el('activityLogBox')) : hide(el('activityLogBox'));
}

/* ---------------------------
Â  Â Initialization
Â  Â --------------------------- */
document.addEventListener('DOMContentLoaded', () => {
Â  // Uppercase inputs behavior
Â  document.querySelectorAll('input.upper').forEach(i => i.addEventListener('input', () => i.value = i.value.toUpperCase()));

Â  // Restore logged in user (if any)
Â  try {
Â  Â  const u = JSON.parse(localStorage.getItem(USER_KEY));
Â  Â  if (u) {
Â  Â  Â  currentUser = u;
Â  Â  Â  hide(el('loginBox'));
Â  Â  Â  show(el('app'));
Â  Â  Â  el('userInfo').textContent = `${u.username} (${u.role})`;
Â  Â  Â  applyPerms();
Â  Â  Â  loadLogs();
Â  Â  Â  loadInv();
Â  Â  Â  buildActivity();
Â  Â  }
Â  } catch (err) { /* ignore */ }

Â  // Button wiring
Â  el('btnLogin').onclick = () => login();
Â  el('btnLogout').onclick = (e) => logout(e);
Â  el('btnQuit').onclick = () => { window.close && window.close(); };

Â  ['loginUser', 'loginPass'].forEach(id => {
Â  Â  el(id).addEventListener('keydown', function(e) {
Â  Â  Â  if (e.key === 'Enter') { e.preventDefault(); login(); }
Â  Â  });
Â  });

Â  // Item actions
Â  el('btnAdd').onclick = () => addItem();
Â  el('btnSave').onclick = () => saveItem();
Â  el('btnRemove').onclick = () => delItem();
Â  el('btnClearForm').onclick = clearForm;

Â  // Import / Export
Â  el('btnExport').onclick = exportInventoryCSV;
Â  el('btnImport').onclick = () => {
Â  Â  const f = el('fileImport').files[0];
Â  Â  if (!f) return alert('Select CSV');
Â  Â  importFile(f);
Â  };
Â  el('btnDownloadTemplate').onclick = downloadTemplate;

Â  // Search (clickable results)
Â  el('btnSearch').onclick = () => {
Â  Â  const q = el('searchBox').value.toLowerCase().trim();
Â  Â  
Â  Â  // FIX: Filter the full inventory to create the new displayed list
Â  Â  displayedInventory = inventory.filter(it => 
Â  Â  Â  !q || FIELDS.some(k => (it[k] || '').toLowerCase().includes(q))
Â  Â  );
Â  Â  
Â  Â  // FIX: Rebuild the table using the filtered (displayedInventory) data
Â  Â  buildTableFromDisplayed(); 
Â  Â  setActionMsg(`Found ${displayedInventory.length} items.`);
Â  };
Â  
Â  el('btnShowAll').onclick = buildTable; // buildTable() resets displayedInventory and calls buildTableFromDisplayed()
Â  el('btnClearSearch').onclick = () => { el('searchBox').value = ''; buildTable(); };

Â  // Activity log controls
Â  el('btnExportLogs').onclick = exportLogs;
Â  el('btnClearLogs').onclick = async () => {
Â  Â  if (confirm('Clear logs?')) {
Â  Â  Â  activityLog = [];
Â  Â  Â  saveLogs();
Â  Â  Â  buildActivity();
Â  Â  Â  setActionMsg('Logs Cleared');
Â  Â  Â  await autoSyncAll(); // AUTO-SYNC on clear
Â  Â  }
Â  };

Â  // Google sync buttons
Â  el('btnSyncInv').onclick = () => syncInventoryToGoogle();
Â  el('btnSyncActivity').onclick = () => syncActivityToGoogle();

Â  // Background auto-sync every 60 seconds
Â  setInterval(() => {
Â  Â  autoSyncAll().catch(err => console.warn('Background auto-sync error:', err));
Â  }, 60000);

Â  // Load initial data
Â  // These calls are placed here to ensure they run even if the user isn't logged in yet, 
Â  // but they will be re-run on successful login as part of the setup.
Â  if (!currentUser) {
Â  Â  loadLogs();
Â  Â  loadInv();
Â  Â  buildActivity();
Â  }
});
</script>
</body>
</html>
